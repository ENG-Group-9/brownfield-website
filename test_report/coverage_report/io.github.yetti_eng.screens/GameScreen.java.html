<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameScreen.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">headless</a> &gt; <a href="index.source.html" class="el_package">io.github.yetti_eng.screens</a> &gt; <span class="el_source">GameScreen.java</span></div><h1>GameScreen.java</h1><pre class="source lang-java linenums">package io.github.yetti_eng.screens;

import java.util.ArrayList;

import com.badlogic.gdx.Gdx;
import com.badlogic.gdx.Input;
import com.badlogic.gdx.Screen;
import com.badlogic.gdx.audio.Sound;
import com.badlogic.gdx.graphics.Color;
import com.badlogic.gdx.graphics.OrthographicCamera;
import com.badlogic.gdx.graphics.Texture;
import com.badlogic.gdx.math.MathUtils;
import com.badlogic.gdx.math.Rectangle;
import com.badlogic.gdx.math.Vector2;
import com.badlogic.gdx.scenes.scene2d.Actor;
import com.badlogic.gdx.scenes.scene2d.Stage;
import com.badlogic.gdx.scenes.scene2d.ui.Button;
import com.badlogic.gdx.scenes.scene2d.ui.Label;
import com.badlogic.gdx.scenes.scene2d.utils.ChangeListener;
import com.badlogic.gdx.scenes.scene2d.utils.TextureRegionDrawable;
import com.badlogic.gdx.utils.Align;
import com.badlogic.gdx.utils.ScreenUtils;

import io.github.yetti_eng.AchievementManager;
import io.github.yetti_eng.EventCounter;
import io.github.yetti_eng.InputHelper;
import io.github.yetti_eng.LeaderboardManager;
import io.github.yetti_eng.MapManager;
import io.github.yetti_eng.Timer;
import io.github.yetti_eng.YettiGame;
import static io.github.yetti_eng.YettiGame.scaled;
import io.github.yetti_eng.entities.Dean;
import io.github.yetti_eng.entities.Entity;
import io.github.yetti_eng.entities.Item;
import io.github.yetti_eng.entities.Player;
import io.github.yetti_eng.entities.SocialSec;
import io.github.yetti_eng.events.BackpackPickupEvent;
import io.github.yetti_eng.events.BackpackTriggerEvent;
import io.github.yetti_eng.events.BobEvent;
import io.github.yetti_eng.events.DoorEvent;
import io.github.yetti_eng.events.HiddenDeductPointsEvent;
import io.github.yetti_eng.events.HiddenSpeedDebuffEvent;
import io.github.yetti_eng.events.HomeworkEvent;
import io.github.yetti_eng.events.IncreasePointsEvent;
import io.github.yetti_eng.events.KeyEvent;
import io.github.yetti_eng.events.SpeedBoostEvent;
import io.github.yetti_eng.events.WallEvent;
import io.github.yetti_eng.events.WinEvent;

public class GameScreen implements Screen {

    // Debug Tools
<span class="nc" id="L53">    private boolean debugMode = false;</span>
    private final com.badlogic.gdx.graphics.glutils.ShapeRenderer debugRenderer;

    private final YettiGame game;
    private final Stage stage;

    private static final int TIMER_LENGTH = 300; // 300s = 5min
<span class="nc" id="L60">    private int deanTriggerTime = 180;</span>

    private Texture playerTexUp;
    private Texture playerTexDown;
    private Texture playerTexLeft;
    private Texture playerTexRight;
    private Texture yetiTexture;
    private Texture socialSecTexture;

    private Texture exitTexture;
    private Texture checkinCodeTexture;
    private Texture doorTexture;
    private Texture doorframeTexture;
    private Texture longBoiTexture;
    private Texture waterSpillTexture;
    private Texture pauseTexture;
    private Texture homeworkTexture;
    private Texture coffeeTexture;
    private Texture backpackTexture;
    private Texture bobTexture;

    private MapManager mapManager;
    private OrthographicCamera camera;

    private OrthographicCamera interfaceCamera;

    private Sound quackSfx;
    private Sound paperSfx;
    private Sound doorSfx;
    private Sound slipSfx;
    private Sound growlSfx;
    private Sound floorboardSfx;
    private Sound sipSfx;
    private Sound sneezeSfx;
    private Sound stubSfx;

    private Player player;
    private Dean dean;
    private SocialSec socialSec;
    private Item exit;
<span class="nc" id="L100">    private final ArrayList&lt;Entity&gt; entities = new ArrayList&lt;&gt;();</span>

    private Label hiddenText;
    private Label negativeText;
    private Label positiveText;
    private Label timerText;
    private Label scoreText;
<span class="nc" id="L107">    private final ArrayList&lt;Label&gt; messages = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L108">    private final ArrayList&lt;Label&gt; largeMessages = new ArrayList&lt;&gt;();</span>
    private Button pauseButton;
    
<span class="nc" id="L111">    private final WallEvent wallEvent = new WallEvent();</span>

<span class="nc" id="L113">    public GameScreen(final YettiGame game) {</span>
<span class="nc" id="L114">        this.game = game;</span>
<span class="nc" id="L115">        stage = new Stage(game.viewport, game.batch);</span>
<span class="nc" id="L116">        debugRenderer = new com.badlogic.gdx.graphics.glutils.ShapeRenderer();</span>
<span class="nc" id="L117">    }</span>

    @Override
    public void show() {
<span class="nc" id="L121">        playerTexUp = new Texture(&quot;character/player_up.png&quot;);</span>
<span class="nc" id="L122">        playerTexDown = new Texture(&quot;character/player_down.png&quot;);</span>
<span class="nc" id="L123">        playerTexLeft = new Texture(&quot;character/player_left.png&quot;);</span>
<span class="nc" id="L124">        playerTexRight = new Texture(&quot;character/player_right.png&quot;);</span>
<span class="nc" id="L125">        yetiTexture = new Texture(&quot;character/yeti.png&quot;);</span>
<span class="nc" id="L126">        socialSecTexture = new Texture(&quot;character/social_sec.png&quot;);</span>

<span class="nc" id="L128">        exitTexture = new Texture(&quot;item/exit.png&quot;);</span>
<span class="nc" id="L129">        checkinCodeTexture = new Texture(&quot;item/checkin_code.png&quot;);</span>
<span class="nc" id="L130">        doorTexture = new Texture(&quot;item/door.png&quot;);</span>
<span class="nc" id="L131">        doorframeTexture = new Texture(&quot;item/doorframe.png&quot;);</span>
<span class="nc" id="L132">        longBoiTexture = new Texture(&quot;item/long_boi.png&quot;);</span>
<span class="nc" id="L133">        waterSpillTexture = new Texture(&quot;item/water_spill.png&quot;);</span>
<span class="nc" id="L134">        homeworkTexture = new Texture(&quot;item/homework.png&quot;);</span>
<span class="nc" id="L135">        coffeeTexture = new Texture(&quot;item/coffee.png&quot;);</span>
<span class="nc" id="L136">        backpackTexture = new Texture(&quot;item/backpack.png&quot;);</span>
<span class="nc" id="L137">        bobTexture = new Texture(&quot;item/bob.png&quot;); </span>

<span class="nc" id="L139">        pauseTexture = new Texture(&quot;ui/pause.png&quot;);</span>

<span class="nc" id="L141">        camera = new  OrthographicCamera();</span>
<span class="nc" id="L142">        camera.setToOrtho(false, 90, 60);</span>
<span class="nc" id="L143">        interfaceCamera = new  OrthographicCamera();</span>
<span class="nc" id="L144">        interfaceCamera.setToOrtho(false, scaled(16), scaled(9));</span>
<span class="nc" id="L145">        mapManager = new MapManager(camera);</span>
<span class="nc" id="L146">        mapManager.loadMap(&quot;map/map.tmx&quot;);</span>
<span class="nc" id="L147">        mapManager.createMapRenderer();</span>

<span class="nc" id="L149">        quackSfx = Gdx.audio.newSound(Gdx.files.internal(&quot;audio/duck_quack.mp3&quot;));</span>
<span class="nc" id="L150">        paperSfx = Gdx.audio.newSound(Gdx.files.internal(&quot;audio/paper_rustle.wav&quot;));</span>
<span class="nc" id="L151">        doorSfx = Gdx.audio.newSound(Gdx.files.internal(&quot;audio/dorm_door_opening.wav&quot;));</span>
<span class="nc" id="L152">        slipSfx = Gdx.audio.newSound(Gdx.files.internal(&quot;audio/cartoon_quick_slip.wav&quot;));</span>
<span class="nc" id="L153">        growlSfx = Gdx.audio.newSound(Gdx.files.internal(&quot;audio/deep_growl_1.wav&quot;));</span>
<span class="nc" id="L154">        floorboardSfx = Gdx.audio.newSound(Gdx.files.internal(&quot;audio/floorboard.wav&quot;));</span>
<span class="nc" id="L155">        sipSfx = Gdx.audio.newSound(Gdx.files.internal(&quot;audio/sip.wav&quot;));</span>
<span class="nc" id="L156">        sneezeSfx = Gdx.audio.newSound(Gdx.files.internal(&quot;audio/sneeze.mp3&quot;));</span>
<span class="nc" id="L157">        stubSfx = Gdx.audio.newSound(Gdx.files.internal(&quot;audio/stub.wav&quot;));</span>

<span class="nc" id="L159">        player = new Player(playerTexDown, 55, 25);</span>
<span class="nc" id="L160">        socialSec = new SocialSec(socialSecTexture, 8, 3);</span>
<span class="nc" id="L161">        exit = new Item(new WinEvent(new LeaderboardManager()), &quot;exit&quot;, exitTexture, 80, 54, 2, 2.2f);</span>
<span class="nc" id="L162">        dean = new Dean(yetiTexture, -2, 4.5f);</span>
<span class="nc" id="L163">        dean.disable();</span>
<span class="nc" id="L164">        dean.hide();</span>

<span class="nc" id="L166">        Item backpack = new Item(new BackpackPickupEvent(), &quot;backpack&quot;, backpackTexture, 20, 6, 2f, 2f, true, false);</span>
        
<span class="nc" id="L168">        entities.add(new Item(new KeyEvent(), &quot;checkin_code&quot;, checkinCodeTexture, 45, 33, 1.5f, 1.5f));</span>
<span class="nc" id="L169">        entities.add(new Item(new DoorEvent(), &quot;door&quot;, doorTexture, 44, 21, 2, 2.2f, false, true));</span>
<span class="nc" id="L170">        entities.add(new Item(new HiddenDeductPointsEvent(), &quot;water_spill&quot;, waterSpillTexture, 59, 11, 3f, 3f, true, true));</span>
        
<span class="nc" id="L172">        entities.add(new Item(new io.github.yetti_eng.events.Event() {</span>
            @Override
<span class="nc" id="L174">            public boolean activate(GameScreen screen, Player player, Item item) { return false; }</span>
            @Override
<span class="nc" id="L176">            public int getScoreModifier() { return 0; }</span>
        }, &quot;homework_prop&quot;, homeworkTexture, 9, 47, 1.5f, 1.5f, false, true));
        
<span class="nc" id="L179">        entities.add(new Item(new HomeworkEvent(), &quot;homework_trigger&quot;, checkinCodeTexture, 9, 45, 1f, 1f, true, false));</span>
<span class="nc" id="L180">        entities.add(new Item(new BackpackTriggerEvent(), &quot;backpack_trigger&quot;, checkinCodeTexture, 66, 27, 2f, 1f, true, false));</span>
<span class="nc" id="L181">        entities.add(socialSec);</span>
<span class="nc" id="L182">        entities.add(backpack);</span>

<span class="nc" id="L184">        spawnRandomItems(3, &quot;long_boi&quot;, longBoiTexture, 1.5f, 1.5f, new IncreasePointsEvent(), false, false);</span>
<span class="nc" id="L185">        spawnRandomItems(5, &quot;floorboard&quot;, doorframeTexture, 1f, 1f, new HiddenSpeedDebuffEvent(), true, false);</span>
<span class="nc" id="L186">        spawnRandomItems(5, &quot;coffee&quot;, coffeeTexture, 1f, 1f, new SpeedBoostEvent(), false, false);</span>
<span class="nc" id="L187">        spawnRandomItems(2, &quot;bob&quot;, bobTexture, 1f, 1f, new BobEvent(), false, false);</span>

        //start new timer
<span class="nc" id="L190">        game.timer = new Timer(TIMER_LENGTH);</span>
<span class="nc" id="L191">        game.timer.play();</span>
        //create labels and position timer and event counters on screen
        // Added a score counter also 
<span class="nc" id="L194">        timerText = new Label(null, new Label.LabelStyle(game.font, Color.WHITE.cpy()));</span>
<span class="nc" id="L195">        timerText.setPosition(0, scaled(8.5f));</span>
        
<span class="nc" id="L197">        hiddenText = new Label(null, new Label.LabelStyle(game.fontBorderedSmall, Color.WHITE.cpy()));</span>
<span class="nc" id="L198">        hiddenText.setPosition(scaled(4f), scaled(8.5f));</span>
        
<span class="nc" id="L200">        negativeText = new Label(null, new Label.LabelStyle(game.fontBorderedSmall, Color.WHITE.cpy()));</span>
<span class="nc" id="L201">        negativeText.setPosition(scaled(7f), scaled(8.5f));</span>
        
<span class="nc" id="L203">        positiveText = new Label(null, new Label.LabelStyle(game.fontBorderedSmall, Color.WHITE.cpy()));</span>
<span class="nc" id="L204">        positiveText.setPosition(scaled(10f), scaled(8.5f));</span>

<span class="nc" id="L206">        scoreText = new Label(&quot;Score: 0&quot;, new Label.LabelStyle(game.fontBorderedSmall, Color.WHITE.cpy()));</span>
<span class="nc" id="L207">        scoreText.setPosition(scaled(0.5f), scaled(0.5f));</span>

<span class="nc" id="L209">        Gdx.input.setInputProcessor(stage);</span>
<span class="nc" id="L210">        pauseButton = new Button(new TextureRegionDrawable(pauseTexture));</span>
<span class="nc" id="L211">        pauseButton.setSize(48, 48);</span>
<span class="nc" id="L212">        pauseButton.setPosition(scaled(15.6f), scaled(8.6f), Align.center);</span>
<span class="nc" id="L213">        pauseButton.addListener(new ChangeListener() {</span>
            @Override
            public void changed(ChangeEvent event, Actor actor) {
<span class="nc bnc" id="L216" title="All 2 branches missed.">                if (game.isPaused()) {</span>
<span class="nc" id="L217">                    game.resume();</span>
                } else {
<span class="nc" id="L219">                    game.pause();</span>
                }
<span class="nc" id="L221">            }</span>
        });
<span class="nc" id="L223">        stage.addActor(pauseButton);</span>
<span class="nc" id="L224">    }</span>

    @Override
    public void render(float delta) {
        // Toggle Debug Mode with Zero key
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (Gdx.input.isKeyJustPressed(com.badlogic.gdx.Input.Keys.NUM_0)) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            debugMode = !debugMode;</span>
        }
<span class="nc" id="L232">        input(delta); //handles player input</span>
<span class="nc" id="L233">        logic(delta); //handles collisions and events</span>
<span class="nc" id="L234">        draw(delta); //draws map and entities to screen</span>
<span class="nc" id="L235">        postLogic(delta); // Used for logic that should happen after rendering, normally screen changes</span>
<span class="nc" id="L236">    }</span>

    private void input(float delta) {
<span class="nc" id="L239">        float dx = 0, dy = 0;</span>
<span class="nc" id="L240">        float currentX = player.getX();</span>
<span class="nc" id="L241">        float currentY = player.getY();</span>
<span class="nc" id="L242">        float speed = player.getSpeedThisFrame(delta);</span>

<span class="nc" id="L244">        player.resetMovement();</span>
        //vertical movement
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (InputHelper.moveUpPressed()) {</span>
<span class="nc" id="L247">            dy  += speed;</span>
<span class="nc" id="L248">            player.setTexture(playerTexUp);</span>
        }
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (InputHelper.moveDownPressed()) {</span>
<span class="nc" id="L251">            dy -= speed;</span>
<span class="nc" id="L252">            player.setTexture(playerTexDown);</span>
        }
        //horizontal movement
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (InputHelper.moveRightPressed()) {</span>
<span class="nc" id="L256">            dx += speed;</span>
<span class="nc" id="L257">            player.setTexture(playerTexRight);</span>
        }
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (InputHelper.moveLeftPressed()) {</span>
<span class="nc" id="L260">            dx -= speed;</span>
<span class="nc" id="L261">            player.setTexture(playerTexLeft);</span>
        }

<span class="nc" id="L264">        Rectangle hitbox = player.getHitbox();</span>
        //tests if collision occurs after x movement
<span class="nc" id="L266">        hitbox.setPosition(currentX + dx, currentY);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (!mapManager.isRectInvalid(player.getHitbox())) {</span>
<span class="nc" id="L268">            player.addMovement(dx, 0);</span>
        } else {
<span class="nc" id="L270">            wallEvent.activate(this, player, null);</span>
        }
        //tests if collision occurs after y movement
<span class="nc" id="L273">        hitbox.setPosition(currentX, currentY + dy );</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (!mapManager.isRectInvalid(player.getHitbox())) {</span>
<span class="nc" id="L275">            player.addMovement(0, dy);</span>
        } else {
<span class="nc" id="L277">            wallEvent.activate(this, player, null);</span>
        }
        //sets the hitbox to correct player location
<span class="nc" id="L280">        hitbox.setPosition(player.getX(), player.getY());</span>
<span class="nc" id="L281">    }</span>

    private void logic(float delta) {
<span class="nc" id="L284">        Vector2 currentPos = player.getCurrentPos(); //save initial position of player</span>
        //move only if game isn't paused
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (!game.isPaused()) {</span>
<span class="nc" id="L287">            player.doMove(delta, true);</span>

<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (socialSec.isEnabled()) {</span>
<span class="nc" id="L290">                socialSec.wander(delta, mapManager);</span>
            }

<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (dean.isEnabled()) {</span>
<span class="nc" id="L294">                dean.calculateMovement(player);</span>
<span class="nc" id="L295">                dean.doMove(delta);</span>
            }
        }

        // Detect collision with objects
<span class="nc" id="L300">        entities.forEach(e -&gt; {</span>
<span class="nc bnc" id="L301" title="All 4 branches missed.">            if (player.collidedWith(e) &amp;&amp; e.isEnabled()) {</span>
                // Check for collision with solid objects
<span class="nc bnc" id="L303" title="All 2 branches missed.">                if (e.isSolid()) {</span>
                    //set the position of player to previous position if collision
<span class="nc" id="L305">                    player.setPosition(currentPos.x, currentPos.y);</span>
                }
                // Check for interaction with items
<span class="nc bnc" id="L308" title="All 2 branches missed.">                if (e instanceof Item item ) {</span>
<span class="nc" id="L309">                    item.interact(game, this, player);</span>
                }
            }
<span class="nc" id="L312">        });</span>

<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (player.collidedWith(socialSec)) {</span>
<span class="nc" id="L315">             socialSec.checkInteraction(this);</span>
        }

        // Clamp to edges of screen
<span class="nc" id="L319">        float worldWidth = game.viewport.getWorldWidth();</span>
<span class="nc" id="L320">        float worldHeight = game.viewport.getWorldHeight();</span>

<span class="nc" id="L322">        float playerWidth = player.getWidth();</span>
<span class="nc" id="L323">        float playerHeight = player.getHeight();</span>

<span class="nc" id="L325">        player.setX(MathUtils.clamp(player.getX(), 0, worldWidth - playerWidth));</span>
<span class="nc" id="L326">        player.setY(MathUtils.clamp(player.getY(), 0, worldHeight - playerHeight));</span>

        // Calculate remaining time
<span class="nc" id="L329">        int timeRemaining = game.timer.getRemainingTime();</span>
<span class="nc" id="L330">        String text = (timeRemaining / 60) + &quot;:&quot; + String.format(&quot;%02d&quot;, timeRemaining % 60);</span>
<span class="nc" id="L331">        timerText.setText(text);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        timerText.setStyle(new Label.LabelStyle(game.fontBordered, (game.timer.isActive() ? Color.WHITE : Color.RED).cpy()));</span>

<span class="nc" id="L334">        scoreText.setText(&quot;Score: &quot; + calculateScore());</span>

        //updates event counters
<span class="nc" id="L337">        hiddenText.setText(&quot;Hidden:&quot; + EventCounter.getHiddenCount());</span>
<span class="nc" id="L338">        positiveText.setText(&quot;Positive:&quot; + EventCounter.getPositiveCount());</span>
<span class="nc" id="L339">        negativeText.setText(&quot;Negative:&quot; + EventCounter.getNegativeCount());</span>

        // Release the dean depending on wether the homework has been collected or not
<span class="nc bnc" id="L342" title="All 4 branches missed.">        if (timeRemaining &lt;= deanTriggerTime &amp;&amp; !dean.isEnabled()) {</span>
<span class="nc" id="L343">            growlSfx.play(game.volume);</span>
<span class="nc" id="L344">            spawnLargeMessage(&quot;Run! The dean is coming!&quot;);</span>
<span class="nc" id="L345">            dean.show();</span>
<span class="nc" id="L346">            dean.enable();</span>
        }

<span class="nc bnc" id="L349" title="All 2 branches missed.">        if (Gdx.input.isKeyJustPressed(Input.Keys.ESCAPE)) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">            if (game.isPaused()) {</span>
<span class="nc" id="L351">                game.resume();</span>
            } else {
<span class="nc" id="L353">                game.pause();</span>
            }
        }
<span class="nc" id="L356">    }</span>

    private void draw(float delta) {
<span class="nc" id="L359">        ScreenUtils.clear(0f, 0f, 0f, 1f);</span>
<span class="nc" id="L360">        camera.update();</span>
        //draw map
<span class="nc" id="L362">        mapManager.render();</span>
<span class="nc" id="L363">        game.viewport.apply();</span>

        //main camera with map and entities
<span class="nc" id="L366">        game.batch.setProjectionMatrix(camera.combined);</span>
<span class="nc" id="L367">        game.batch.begin();</span>
        // Draw only visible entities
<span class="nc bnc" id="L369" title="All 2 branches missed.">        entities.forEach(e -&gt; { if (e.isVisible()) e.draw(game.batch); });</span>
        // Draw exit, player, and dean on top of other entities
<span class="nc bnc" id="L371" title="All 2 branches missed.">        if (exit.isVisible()) exit.draw(game.batch);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (player.isVisible()) player.draw(game.batch);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (dean.isVisible()) dean.draw(game.batch);</span>
<span class="nc" id="L374">        game.batch.end();</span>

        //separate user interface camera for text on screen
<span class="nc" id="L377">        game.batch.setProjectionMatrix(interfaceCamera.combined);</span>
<span class="nc" id="L378">        game.batch.begin();</span>

<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (game.isPaused()) {</span>
<span class="nc" id="L381">            game.fontBordered.draw(</span>
                game.batch, &quot;PAUSED&quot;,
                0, interfaceCamera.viewportHeight / 2, interfaceCamera.viewportWidth,
                Align.center, false
            );
        }

        //draw timer and event counters to screen
<span class="nc" id="L389">        timerText.draw(game.batch, 1.0f);</span>
<span class="nc" id="L390">        hiddenText.draw(game.batch, 1.0f);</span>
<span class="nc" id="L391">        positiveText.draw(game.batch, 1.0f);</span>
<span class="nc" id="L392">        negativeText.draw(game.batch, 1.0f);</span>
<span class="nc" id="L393">        scoreText.draw(game.batch, 1.0f);</span>

        // MODIFIED (Assessment 2)
        // Previously messages overlapped with each other, so code has been
        // added to prevent this.
        // Also previously regular messages and large messages at the centre of
        // of the screen were handled identically, so adding this overlap
        // prevention code caused issues (regular messages should not affect
        // the position of large messages).
        // To fix this another list has been created to separate the large
        // messages out.
<span class="nc" id="L404">        drawMessages(messages);</span>
<span class="nc" id="L405">        drawMessages(largeMessages);</span>

<span class="nc" id="L407">        game.batch.end();</span>

<span class="nc bnc" id="L409" title="All 2 branches missed.">        if (debugMode) {</span>
<span class="nc" id="L410">            debugRenderer.setProjectionMatrix(camera.combined);</span>
<span class="nc" id="L411">            debugRenderer.begin(com.badlogic.gdx.graphics.glutils.ShapeRenderer.ShapeType.Line);</span>
            
            // Draw Grid
<span class="nc" id="L414">            debugRenderer.setColor(com.badlogic.gdx.graphics.Color.RED);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">            for (int x = 0; x &lt; 100; x++) {</span>
<span class="nc" id="L416">                debugRenderer.line(x, 0, x, 100);</span>
            }
<span class="nc bnc" id="L418" title="All 2 branches missed.">            for (int y = 0; y &lt; 100; y++) {</span>
<span class="nc" id="L419">                debugRenderer.line(0, y, 100, y);</span>
            }
            
            // Draw Player Box
<span class="nc" id="L423">            debugRenderer.setColor(com.badlogic.gdx.graphics.Color.YELLOW);</span>
<span class="nc" id="L424">            debugRenderer.rect(player.getX(), player.getY(), player.getWidth(), player.getHeight());</span>

            // Draw Positive Event Boxes
<span class="nc" id="L427">            debugRenderer.setColor(com.badlogic.gdx.graphics.Color.GREEN);</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            for (Entity e : entities) {</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                if (e instanceof Item item) {</span>
<span class="nc bnc" id="L430" title="All 4 branches missed.">                    if (item.getEvent() instanceof IncreasePointsEvent || item.getEvent() instanceof SpeedBoostEvent) {</span>
<span class="nc" id="L431">                        debugRenderer.rect(item.getX(), item.getY(), item.getWidth(), item.getHeight());</span>
                    }
                }
<span class="nc" id="L434">            }</span>
            
<span class="nc" id="L436">            debugRenderer.end();</span>

<span class="nc" id="L438">            debugRenderer.begin(com.badlogic.gdx.graphics.glutils.ShapeRenderer.ShapeType.Filled);</span>
<span class="nc" id="L439">            debugRenderer.setColor(com.badlogic.gdx.graphics.Color.BLACK);</span>
            
<span class="nc bnc" id="L441" title="All 2 branches missed.">            for (Entity e : entities) {</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">                if (!e.isVisible()) {</span>
<span class="nc" id="L443">                    debugRenderer.rect(e.getX(), e.getY(), e.getWidth(), e.getHeight());</span>
                }
<span class="nc" id="L445">            }</span>
<span class="nc" id="L446">            debugRenderer.end();</span>
            
<span class="nc bnc" id="L448" title="All 2 branches missed.">            if (Gdx.input.isButtonJustPressed(com.badlogic.gdx.Input.Buttons.LEFT)) {</span>
<span class="nc" id="L449">                com.badlogic.gdx.math.Vector3 worldPos = camera.unproject(new com.badlogic.gdx.math.Vector3(Gdx.input.getX(), Gdx.input.getY(), 0));</span>
<span class="nc" id="L450">                Gdx.app.log(&quot;DEBUG&quot;, &quot;Clicked at: &quot; + (int)worldPos.x + &quot;, &quot; + (int)worldPos.y);</span>
            }
        }

        // Finally, draw elements on the stage (clickable elements)
<span class="nc" id="L455">        stage.draw();</span>
<span class="nc" id="L456">    }</span>

    private void postLogic(float delta) {
        // Exit collision
<span class="nc bnc" id="L460" title="All 4 branches missed.">        if (player.collidedWith(exit) &amp;&amp; exit.isEnabled()) {</span>
            // MODIFIED (Assessment 2): Centralised Win Logic
            // Previously just called exit.interact() 
            // Now calls handleWin() to calculate score and check Leaderboard (UR_SCORING, UR_MAIN_MENU).
<span class="nc" id="L464">            handleWin();</span>
<span class="nc" id="L465">            return;</span>
        }

        // Dean collision
<span class="nc bnc" id="L469" title="All 4 branches missed.">        if (player.collidedWith(dean) &amp;&amp; dean.isEnabled()) {</span>
            // MODIFIED (Assessment 2)
            // Previously called dean.getsPlayer(game) which switched screens without passing a score.
            // Now calculates score locally to satisfy UR_SCORING and passes it to LoseScreen.
<span class="nc" id="L473">            int finalScore = calculateScore();</span>
<span class="nc" id="L474">            game.setScreen(new LoseScreen(game, finalScore));</span>
<span class="nc" id="L475">            AchievementManager.unlockAchievement(5);</span>
<span class="nc" id="L476">            dispose();</span>
<span class="nc" id="L477">            return;</span>
        }

        // Timer runs out
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (game.timer.hasElapsed()) {</span>
<span class="nc" id="L482">            game.timer.finish();</span>
            
            // MODIFIED (Assessment 2)
            // Previously just switched to LoseScreen(). 
            // Now calculates final score to display on End Screen (UR_ENDING).
<span class="nc" id="L487">            int finalScore = calculateScore();</span>
            
<span class="nc" id="L489">            game.setScreen(new LoseScreen(game, finalScore));</span>
<span class="nc" id="L490">            dispose();</span>
        }
<span class="nc" id="L492">    }</span>
    
    /**
     * Calculates the score based on remaining time and events.
     * Formula: (Time * 10) + (Positive * 100) - (Negative * 50)
     */
    private int calculateScore() {
<span class="nc" id="L499">        int timeRemaining = game.timer.getRemainingTime();</span>
<span class="nc" id="L500">        int positive = EventCounter.getPositiveCount();</span>
<span class="nc" id="L501">        int negative = EventCounter.getNegativeCount();</span>
        
<span class="nc" id="L503">        int ducksCollected = 0;</span>
<span class="nc" id="L504">        boolean backpackCollected = false;</span>

<span class="nc bnc" id="L506" title="All 2 branches missed.">        for (Entity e : entities) {</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">            if (e instanceof Item i) {</span>
<span class="nc bnc" id="L508" title="All 4 branches missed.">                if (&quot;long_boi&quot;.equals(i.getID()) &amp;&amp; i.isUsed()) {</span>
<span class="nc" id="L509">                    ducksCollected++;</span>
                }
<span class="nc bnc" id="L511" title="All 4 branches missed.">                if (&quot;backpack&quot;.equals(i.getID()) &amp;&amp; i.isUsed()) {</span>
<span class="nc" id="L512">                    backpackCollected = true;</span>
                }
            }
<span class="nc" id="L515">        }</span>
        
<span class="nc bnc" id="L517" title="All 2 branches missed.">        int bonus = (ducksCollected &gt;= 3) ? 2000 : 0;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">        int backpackBonus = backpackCollected ? 1000 : 0;</span>
        
<span class="nc" id="L520">        int score = (timeRemaining * 10) + (positive * 100) - (negative * 50) + bonus + backpackBonus;        return Math.max(0, score); // Score can't go below 0</span>
    }

    /**
     * Spawns a set number of items at random valid locations.
     */
    private void spawnRandomItems(int count, String id, Texture tex, float width, float height, io.github.yetti_eng.events.Event event, boolean hidden, boolean solid) {
<span class="nc" id="L527">        int spawned = 0;</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">        while (spawned &lt; count) {</span>
<span class="nc" id="L529">            int rx = MathUtils.random(5, 85);</span>
<span class="nc" id="L530">            int ry = MathUtils.random(5, 55);</span>

<span class="nc bnc" id="L532" title="All 2 branches missed.">            if (!mapManager.isPositionInvalid(rx + (width / 2f), ry + (height / 2f))) {</span>
                
<span class="nc" id="L534">                boolean overlaps = false;</span>
<span class="nc" id="L535">                Rectangle potentialRect = new Rectangle(rx, ry, width, height);</span>
                
<span class="nc bnc" id="L537" title="All 2 branches missed.">                if (player.getHitbox().overlaps(potentialRect)) overlaps = true;</span>
                
<span class="nc bnc" id="L539" title="All 2 branches missed.">                for (Entity e : entities) {</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">                    if (e.getHitbox().overlaps(potentialRect)) {</span>
<span class="nc" id="L541">                        overlaps = true;</span>
<span class="nc" id="L542">                        break;</span>
                    }
<span class="nc" id="L544">                }</span>

<span class="nc bnc" id="L546" title="All 2 branches missed.">                if (!overlaps) {</span>
<span class="nc" id="L547">                    entities.add(new Item(event, id, tex, rx, ry, width, height, hidden, solid));</span>
<span class="nc" id="L548">                    spawned++;</span>
<span class="nc" id="L549">                    Gdx.app.log(&quot;GameScreen&quot;, &quot;Spawned &quot; + id + &quot; at: &quot; + rx + &quot;, &quot; + ry); </span>
                }
            }
<span class="nc" id="L552">        }</span>
<span class="nc" id="L553">    }</span>
    
    /**
     * Handles the win logic: calculates score, checks leaderboard,
     * and directs to the appropriate screen.
     */
    private void handleWin() {
<span class="nc" id="L560">        int score = calculateScore();</span>
<span class="nc" id="L561">        LeaderboardManager leaderboardManager = new LeaderboardManager();</span>

<span class="nc bnc" id="L563" title="All 2 branches missed.">        if (player.countItemsWithID(&quot;bob&quot;) == 2) {</span>
<span class="nc" id="L564">            AchievementManager.unlockAchievement(2);</span>
        }
<span class="nc bnc" id="L566" title="All 2 branches missed.">        if (player.countItemsWithID(&quot;floorboard&quot;) == 5) {</span>
<span class="nc" id="L567">            AchievementManager.unlockAchievement(3);</span>
        }
<span class="nc bnc" id="L569" title="All 2 branches missed.">        if (player.countItemsWithID(&quot;floorboard&quot;) == 0) {</span>
<span class="nc" id="L570">            AchievementManager.unlockAchievement(4);</span>
        }
<span class="nc bnc" id="L572" title="All 2 branches missed.">        if (dean.isEnabled()) {</span>
<span class="nc" id="L573">            AchievementManager.unlockAchievement(6);</span>
        }
<span class="nc bnc" id="L575" title="All 2 branches missed.">        if (!player.getTouchedWall()) {</span>
<span class="nc" id="L576">            AchievementManager.unlockAchievement(7);</span>
        }
        
<span class="nc bnc" id="L579" title="All 2 branches missed.">        if (leaderboardManager.isHighScore(score)) {</span>
<span class="nc" id="L580">            game.setScreen(new NameInputScreen(game, score));</span>
        } else {
<span class="nc" id="L582">            game.setScreen(new WinScreen(game, score));</span>
        }
<span class="nc" id="L584">        dispose();</span>
<span class="nc" id="L585">    }</span>

    @Override
    public void resize(int width, int height) {
<span class="nc" id="L589">        game.viewport.update(width, height, true);</span>
<span class="nc" id="L590">    }</span>

    @Override
    public void pause() {
<span class="nc" id="L594">        game.timer.pause();</span>
<span class="nc" id="L595">    }</span>

    @Override
    public void resume() {
<span class="nc" id="L599">        game.timer.play();</span>
<span class="nc" id="L600">    }</span>

    @Override
<span class="nc" id="L603">    public void hide() {}</span>

    @Override
    public void dispose() {
<span class="nc" id="L607">        playerTexUp.dispose();</span>
<span class="nc" id="L608">        playerTexDown.dispose();</span>
<span class="nc" id="L609">        playerTexLeft.dispose();</span>
<span class="nc" id="L610">        playerTexRight.dispose();</span>
<span class="nc" id="L611">        yetiTexture.dispose();</span>
<span class="nc" id="L612">        socialSecTexture.dispose();</span>

<span class="nc" id="L614">        exitTexture.dispose();</span>
<span class="nc" id="L615">        checkinCodeTexture.dispose();</span>
<span class="nc" id="L616">        doorTexture.dispose();</span>
<span class="nc" id="L617">        doorframeTexture.dispose();</span>
<span class="nc" id="L618">        longBoiTexture.dispose();</span>
<span class="nc" id="L619">        waterSpillTexture.dispose();</span>
<span class="nc" id="L620">        homeworkTexture.dispose();</span>
<span class="nc" id="L621">        coffeeTexture.dispose();</span>
<span class="nc" id="L622">        backpackTexture.dispose();</span>
<span class="nc" id="L623">        bobTexture.dispose(); </span>

<span class="nc" id="L625">        pauseTexture.dispose();</span>
<span class="nc" id="L626">        mapManager.dispose();</span>
<span class="nc" id="L627">        stage.dispose();</span>

<span class="nc" id="L629">        quackSfx.dispose();</span>
<span class="nc" id="L630">        paperSfx.dispose();</span>
<span class="nc" id="L631">        doorSfx.dispose();</span>
<span class="nc" id="L632">        slipSfx.dispose();</span>
<span class="nc" id="L633">        growlSfx.dispose();</span>
<span class="nc" id="L634">        floorboardSfx.dispose();</span>
<span class="nc" id="L635">        sipSfx.dispose();</span>
<span class="nc" id="L636">        sneezeSfx.dispose();</span>
<span class="nc" id="L637">        stubSfx.dispose();</span>
<span class="nc" id="L638">    }</span>

    /**
     * Spawn a text label at the centre of the screen
     * that floats upwards and fades out. Used to alert the player.
     * @param text The text that should be displayed.
     */
    public void spawnLargeMessage(String text) {
<span class="nc" id="L646">        Label label = new Label(text, new Label.LabelStyle(game.fontBordered, Color.WHITE.cpy()));</span>
<span class="nc" id="L647">        label.setPosition(scaled(8), scaled(4.5f), Align.center);</span>
<span class="nc" id="L648">        largeMessages.add(label);</span>
<span class="nc" id="L649">    }</span>

    /**
     * Spawn a small text label at the bottom right of the screen
     * that floats upwards and fades out. Used when interacting with Items.
     * @param text The text that should be displayed.
     */
    public void spawnInteractionMessage(String text) {
<span class="nc" id="L657">        Label label = new Label(text, new Label.LabelStyle(game.fontBorderedSmall, Color.WHITE.cpy()));</span>
<span class="nc" id="L658">        label.setPosition(interfaceCamera.viewportWidth, 0, Align.bottomRight);</span>
<span class="nc" id="L659">        messages.add(label);</span>
<span class="nc" id="L660">    }</span>

    private void drawMessages(ArrayList&lt;Label&gt; m) {
        //draws messages fading out in an upwards direction,
        //prevents them from overlapping
<span class="nc" id="L665">        float previousMessageTop = 0;</span>
<span class="nc" id="L666">        float newMessageBottom = 0;</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">        if (!m.isEmpty()) {</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">            for (int i = m.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L669">                Label l = m.get(i);</span>
<span class="nc" id="L670">                l.getColor().add(0, 0, 0, -0.003f);</span>
<span class="nc" id="L671">                newMessageBottom = Math.max(</span>
<span class="nc" id="L672">                    l.getTop() - l.getHeight() + 0.5f,</span>
                    previousMessageTop
                );
<span class="nc" id="L675">                previousMessageTop = newMessageBottom + l.getHeight();</span>
<span class="nc" id="L676">                l.setPosition(</span>
<span class="nc" id="L677">                    l.getX(Align.center),</span>
                    newMessageBottom,
                    Align.bottom
                );
<span class="nc" id="L681">                l.draw(game.batch, 1);</span>
            }
<span class="nc bnc" id="L683" title="All 2 branches missed.">            m.removeIf(l -&gt; l.getColor().a &lt;= 0);</span>
        }
<span class="nc" id="L685">    }</span>

    public void setDeanTriggerTime(int secondsRemaining) {
<span class="nc" id="L688">        this.deanTriggerTime = secondsRemaining;</span>
<span class="nc" id="L689">    }</span>

    public Texture getDoorframeTexture() {
<span class="nc" id="L692">        return doorframeTexture;</span>
    }

    public Sound getQuackSfx() {
<span class="nc" id="L696">        return quackSfx;</span>
    }

    public Sound getPaperSfx() {
<span class="nc" id="L700">        return paperSfx;</span>
    }

    public Sound getDoorSfx() {
<span class="nc" id="L704">        return doorSfx;</span>
    }

    public Sound getSlipSfx() {
<span class="nc" id="L708">        return slipSfx;</span>
    }

    public Sound getFloorboardSfx() {
<span class="nc" id="L712">        return floorboardSfx;</span>
    }

    public Sound getSipSfx() {
<span class="nc" id="L716">        return sipSfx;</span>
    }

    public Sound getSneezeSfx() {
<span class="nc" id="L720">        return sneezeSfx;</span>
    }

    public Sound getStubSfx() {
<span class="nc" id="L724">        return stubSfx;</span>
    }

    public ArrayList&lt;Entity&gt; getEntities() {
<span class="nc" id="L728">        return entities;</span>
    }

    /**
     * @return The current YettiGame object.
     */
    public YettiGame getGame() {
<span class="nc" id="L735">        return game;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>